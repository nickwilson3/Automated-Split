<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Edit Jury Assignments</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
        <style>
            .scoreboard {
                position: sticky;
                top: 0;
                z-index: 1000;
                background-color: white;
                border-bottom: 2px solid #dee2e6;
                padding: 10px 0;
                margin-bottom: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .jury-card {
                border: 1px solid #dee2e6;
                border-radius: 5px;
                padding: 10px;
                margin-bottom: 10px;
                background-color: #f8f9fa;
            }
            .jury-card-header {
                font-weight: bold;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 5px;
                margin-bottom: 5px;
            }
            .pd-balanced {
                background-color: #d1e7dd;
            }
            .pd-unbalanced {
                background-color: #f8d7da;
            }
            .stats-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 3px;
            }
            .stats-label {
                font-weight: bold;
            }
        </style>
    </head>
<body>
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header text-center">
                        <h2>Edit Jury Assignments</h2>
                    </div>
                    <div class="card-body">
                        {% with messages = get_flashed_messages() %}
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-danger">{{ message }}</div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        
                        <div class="alert alert-info">
                            <p><strong>Instructions:</strong> You can edit jury assignments by changing the jury number in the dropdown menu for each juror. When you're satisfied with the assignments, click "Confirm Final Split" to generate the final report.</p>
                        </div>
                        <div class="scoreboard">
                            <h3 class="mb-3">Jury Balance Scoreboard</h3>
                            <div class="row" id="scoreboard-container">
                                <!-- Jury cards will be generated dynamically by JavaScript -->
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="filter-jury" class="form-label">Filter by Jury:</label>
                                <select class="form-select" id="filter-jury">
                                    <option value="all">Show All Juries</option>
                                    <option value="Unassigned">Unassigned</option>
                                    {% for jury in juries %}
                                    <option value="{{ jury }}">Jury {{ jury_letter(jury) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filter-leaning" class="form-label">Filter by Leaning:</label>
                                <select class="form-select" id="filter-leaning">
                                    <option value="all">Show All Leanings</option>
                                    <option value="P">P</option>
                                    <option value="P+">P+</option>
                                    <option value="D">D</option>
                                    <option value="D+">D+</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="assignments-table">
                                <thead>
                                    <tr>
                                        <th>Jury</th>
                                        <th>Name</th>
                                        <th>Leaning</th>
                                        <th>Gender</th>
                                        <th>Race</th>
                                        <th>Age</th>
                                        <th>Education</th>
                                        <th>Marital Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for juror in assignments %}
                                    <tr data-jury="{{ juror.jury }}" data-leaning="{{ juror.Final_Leaning }}">
                                        <td>
                                            <select class="form-select jury-select" data-juror-index="{{ loop.index0 }}">
                                                <option value="Unassigned" {% if juror.jury == 'Unassigned' %}selected{% endif %}>Unassigned</option>
                                                {% for jury in juries %}
                                                <option value="{{ jury }}" {% if jury == juror.jury %}selected{% endif %}>{{ jury_letter(jury) }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>{{ juror.Name }}</td>
                                        <td {% if juror.Final_Leaning in ['P', 'P+'] %}class="text-primary"{% else %}class="text-danger"{% endif %}>
                                            {{ juror.Final_Leaning }}
                                        </td>
                                        <td>{{ juror.Gender }}</td>
                                        <td>{{ juror.Race }}</td>
                                        <td>{{ juror.Age }}</td>
                                        <td>{{ juror.Education }}</td>
                                        <td>{{ juror.Marital }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-between">
                            <button id="save-changes" class="btn btn-primary">Save Changes</button>
                            <form action="{{ url_for('generate_report') }}" method="post">
                                <button type="submit" class="btn btn-primary">Confirm Final Split</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

    <script id="assignments-data" type="application/json">
        {{ assignments|tojson }}
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Edit page script loaded');
            
            // Store the assignments data
            const assignmentsData = JSON.parse(document.getElementById('assignments-data').textContent);

            //Initialize the scoreboard
            updateScoreboard();
            
            // Filter functionality
            document.getElementById('filter-jury').addEventListener('change', filterTable);
            document.getElementById('filter-leaning').addEventListener('change', filterTable);
            
            function filterTable() {
                const juryFilter = document.getElementById('filter-jury').value;
                const leaningFilter = document.getElementById('filter-leaning').value;
    
                const juryFilterStr = String(juryFilter);
                const leaningFilterStr = String(leaningFilter);
                
                const rows = document.querySelectorAll('#assignments-table tbody tr');
                
                rows.forEach(row => {
                    const jury = row.getAttribute('data-jury');
                    const leaning = row.getAttribute('data-leaning');
                    
                    const juryMatch = juryFilter === 'all' || jury === juryFilter;
                    const leaningMatch = leaningFilter === 'all' || leaning === leaningFilter;
                    
                    if (juryMatch && leaningMatch) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // Function to update the scoreboard
            function updateScoreboard() {
                // Get unique juries
                const juries = [...new Set(assignmentsData.map(juror => juror.jury))].filter(jury => jury !== 'Unassigned').sort();
                
                // Calculate stats for each jury
                const juryStats = {};
                
                // Initialize stats for each jury
                juries.forEach(jury => {
                    juryStats[jury] = {
                        total: 0,
                        leaning: { 'P': 0, 'P+': 0, 'D': 0, 'D+': 0 },
                        gender: {},
                        race: {},
                        ageGroup: {},
                        education: {},
                        marital: {}
                    };
                });
                
                // Add "Unassigned" category if there are unassigned jurors
                if (assignmentsData.some(juror => juror.jury === 'Unassigned')) {
                    juryStats['Unassigned'] = {
                        total: 0,
                        leaning: { 'P': 0, 'P+': 0, 'D': 0, 'D+': 0 },
                        gender: {},
                        race: {},
                        ageGroup: {},
                        education: {},
                        marital: {}
                    };
                }
                
                // Count demographics for each jury
                assignmentsData.forEach(juror => {
                    const jury = juror.jury;
                    
                    if (jury in juryStats) {
                        juryStats[jury].total++;
                        
                        // Count leaning
                        if (juror.Final_Leaning) {
                            juryStats[jury].leaning[juror.Final_Leaning] = (juryStats[jury].leaning[juror.Final_Leaning] || 0) + 1;
                        }
                        
                        // Count gender
                        if (juror.Gender) {
                            juryStats[jury].gender[juror.Gender] = (juryStats[jury].gender[juror.Gender] || 0) + 1;
                        }
                        
                        // Count race
                        if (juror.Race) {
                            juryStats[jury].race[juror.Race] = (juryStats[jury].race[juror.Race] || 0) + 1;
                        }
                        
                        // Count age groups
                        if (juror.AgeGroup) {
                            juryStats[jury].ageGroup[juror.AgeGroup] = (juryStats[jury].ageGroup[juror.AgeGroup] || 0) + 1;
                        }
                        
                        // Count education
                        if (juror.Education) {
                            juryStats[jury].education[juror.Education] = (juryStats[jury].education[juror.Education] || 0) + 1;
                        }
                        
                        // Count marital status
                        if (juror.Marital) {
                            juryStats[jury].marital[juror.Marital] = (juryStats[jury].marital[juror.Marital] || 0) + 1;
                        }
                    }
                });
                
                // Generate HTML for scoreboard
                const scoreboardContainer = document.getElementById('scoreboard-container');
                scoreboardContainer.innerHTML = '';
                
                // Calculate columns based on number of juries
                const colSize = Math.max(3, Math.floor(12 / (Object.keys(juryStats).length)));
                
                for (const [jury, stats] of Object.entries(juryStats)) {
                    // Don't show unassigned in the main scoreboard if it's empty
                    if (jury === 'Unassigned' && stats.total === 0) continue;
                    
                    // Convert numeric jury to letter
                    let juryLabel;
                    if (jury === 'Unassigned') {
                        juryLabel = 'Unassigned';
                    } else if (!isNaN(jury)) {
                        juryLabel = String.fromCharCode(64 + parseInt(jury)); // Convert 1 to A, 2 to B, etc.
                    } else {
                        juryLabel = jury;
                    }
                    
                    // Calculate P/D balance
                    const pTotal = (stats.leaning['P'] || 0) + (stats.leaning['P+'] || 0);
                    const dTotal = (stats.leaning['D'] || 0) + (stats.leaning['D+'] || 0);
                    const balanceClass = Math.abs(pTotal - dTotal) <= 1 ? 'pd-balanced' : 'pd-unbalanced';
                    
                    const juryCard = document.createElement('div');
                    juryCard.className = `col-md-${colSize} mb-3`;
                    juryCard.innerHTML = `
                        <div class="jury-card ${balanceClass}">
                            <div class="jury-card-header">Jury ${juryLabel} (${stats.total})</div>
                            <div class="stats-row">
                                <span class="stats-label">P/D Balance:</span>
                                <span>${pTotal}P / ${dTotal}D</span>
                            </div>
                            <div class="stats-row">
                                <span class="stats-label">Gender:</span>
                                <span>${formatDemographic(stats.gender)}</span>
                            </div>
                            <div class="stats-row">
                                <span class="stats-label">Race:</span>
                                <span>${formatDemographic(stats.race, true)}</span>
                            </div>
                        </div>
                    `;
                    
                    scoreboardContainer.appendChild(juryCard);
                }
            }
            
            // Helper function to format demographic counts
            function formatDemographic(counts, abbreviated = false) {
                if (!counts || Object.keys(counts).length === 0) return 'N/A';
                
                return Object.entries(counts)
                    .map(([key, value]) => {
                        // Abbreviate if requested and the key is longer than 6 characters
                        const displayKey = abbreviated && key.length > 6 ? 
                            key.substring(0, 5) + '.' : 
                            key;
                        return `${value} ${displayKey}`;
                    })
                    .join(', ');
            }
            
            // Handle jury selection change
            document.querySelectorAll('.jury-select').forEach(select => {
                select.addEventListener('change', function() {
                    const jurorIndex = this.getAttribute('data-juror-index');
                    const newJury = this.value;
                    
                    // Update the row's data attribute for filtering
                    this.closest('tr').setAttribute('data-jury', newJury);
                    
                    // Update the assignments data
                    assignmentsData[jurorIndex].jury = newJury;
                });
            });
            
            // Save changes button
            document.getElementById('save-changes').addEventListener('click', function() {
                console.log('Save button clicked');
                
                // Send data to server
                fetch('/save_edits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(assignmentsData)
                })
                .then(response => {
                    console.log('Response received', response);
                    return response.json();
                })
                .then(data => {
                    console.log('Data received', data);
                    if (data.status === 'success') {
                        alert('Changes saved successfully');
                    } else {
                        alert('Error saving changes: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving changes. Please try again.');
                });
            });
        });
    </script>
</body>
</html>